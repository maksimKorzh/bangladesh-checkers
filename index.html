<html lang="en" style="touch-action: none;">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <base href="bangladesh-checkers">
    <style>
      html, body { margin: 0; padding: 0; width: 100%; height: 100dvh; background-color: #000000; }
      body { padding: 0px; margin: 0px; font-family: monospace; font-size: 30px; background-color: black; }
      button { width: 100%; height: 100px; font-size: inherit; font-family: inherit; background-color: #222; color: grey; }
      .highlight { box-shadow: inset 0px 0px 20px 20px #ff3300; }
    </style>
  </head>
  <body>
    <div id="game-container" style="display: flex; flex-direction: column; align-items: center; width: 100%; height: 100%;">
      <div id="board"></div>
      <div id="buttons" style="display: flex; justify-content: center; gap: 6px; margin-top: 10px;">
        <button onclick="window.location.reload();">Play</button>
        <button onclick="ai ^= 1; alert('AI is now ' + (ai ? 'on' : 'off'));">AI</button>
        <button id="undo">Undo</button>
        <button id="move">Move</button>
        <button id="flip">Flip</button>
      </div>
    </div>
    <script>
      let size = parseInt(window.innerHeight / 12.1);
      
      var board = [
        3, 3, 3, 3, 3, 3, 3,
        3, 2, 2, 2, 2, 2, 3,
        3, 2, 2, 2, 2, 2, 3,
        3, 2, 2, 2, 2, 2, 3,
        3, 0, 0, 0, 0, 0, 3,
        3, 0, 0, 0, 0, 0, 3,
        3, 1, 1, 1, 1, 1, 3,
        3, 1, 1, 1, 1, 1, 3,
        3, 1, 1, 1, 1, 1, 3,
        3, 3, 3, 3, 3, 3, 3,
      ];
      
      var pst = [
        0,  3,  3,  3,  3,  3,  0,
        0, -3, -3, -3, -3, -3,  0,
        0, -2, -2, -2, -2, -2,  0,
        0, -1, -1, -1, -1, -1,  0,
        0,  1,  2,  3,  2,  1,  0,
        0,  1,  2,  3,  2,  1,  0,
        0, -1, -1, -1, -1, -1,  0,
        0, -2, -2, -2, -2, -2,  0,
        0, -3, -3, -3, -3, -3,  0,
        0,  0,  0,  0,  0,  0,  0,
      ];
      
      var side = 1;
      var clickLock = 0;
      var flip = 0;
      var userSrc, userDst;
      var legalMoves = [];
      var gameMoves = [];
      var gameOver = 0;
      var ai = 1;
      
      function drawBoard() {
        let boardHTML = `<table bgcolor="#996633" align="center" cellspacing="1" `;
        boardHTML += `style=" -moz-user-select: none; -webkit-user-select: none; -ms-user-select: none;`;
        boardHTML += `user-select: none; -o-user-select: none; border: 10px solid #996633;"`;
        boardHTML += `unselectable="on" onselectstart="return false;" onmousedown="return false;"`;
        for (let row = 0; row < 9; row++) {
          boardHTML+= '<tr>';
          for (let col = 0; col < 7; col++) {
            let file, rank;
            if (flip) {
              file = 7-1-col;
              rank = 10-1-row;
            } else {
              file = col;
              rank = row;
            }
            let sq = rank * 7 + file;
            if (board[sq] == 3) continue;
            boardHTML+= '<td align="center" id="' + sq + 
                 '" style="width: ' + size + 'px; height: ' + size + 'px; font-size: ' + size + 'px; border: 1px solid black;"' +
                 ' onclick="userMove(this.id)">' + ['<span style=\'visibility:hidden\'>\uD83E\uDD5A</span>', '\uD83E\uDD5A', '\uD83C\uDF4B'][board[sq]] +
                 '</td>';
          } boardHTML+= '</tr>';
        } boardHTML+= '</table>';
        document.getElementById('board').innerHTML = boardHTML;
        document.getElementById('buttons').style.width = (document.getElementById('board').offsetWidth) + 'px';
        setTimeout(function() { isGameOver(); }, 200);
      } drawBoard();
    
      function generateMoves() {
        let moves = [];
        let srcSq, dstSq, capSq, pce, capPce;
        for (let sq = 0; sq < board.length; sq++) {
          if (board[sq] == 3) continue;
          srcSq = sq;
          pce = board[srcSq];
          if (pce != side) continue;
          for (let dir of [+1, -1, +7, -7]) {
            dstSq = srcSq + dir;
            capSq = dstSq;
            if (board[capSq] == side || board[capSq] == 3) continue;
            if (board[capSq] == (3-side)) {
              if (board[capSq + dir] == 0) dstSq = capSq + dir;
              else continue;
            }
            capPce = board[capSq];
            moves.push([srcSq, dstSq, capSq, pce, capPce]);
          }
        } return moves;
      }
    
      function moreCapture(move) {
        for (let dir of [+1, -1, +7, -7])
          if (gameMoves[gameMoves.length-1][0][4] && board[move[1] + dir] == side && board[move[1] + dir + dir] == 0) return 1;
        return 0;
      }
    
      function makeMove(move) {
        board[move[2]] = 0;
        board[move[1]] = move[3];
        board[move[0]] = 0;
        side = 3 - side;
      }
      
      function takeBack(move) {
        board[move[0]] = move[3];
        board[move[1]] = 0;
        board[move[2]] = move[4];
        side = 3 - side;
      }
      
      function evaluate() {
        let score = 0;
        for (let sq = 0; sq < board.length; sq++) {
          if (board[sq] == 3) continue;
          if (board[sq] == 1) score += 50 + pst[sq];
          if (board[sq] == 2) score -= 50 + pst[sq];
        } return (side == 1) ? score : -score
      }
    
      function search(depth, alpha = -Infinity, beta = Infinity) {
        let oldSide = side;
        let bestMove = null;
        const originalDepth = depth;
        function negamax(depth, alpha, beta) {
          if (depth === 0) return evaluate(oldSide);
          let bestScore = -Infinity;
          const moves = generateMoves();
          if (moves.length === 0) return -Infinity;
          for (const move of moves) {
            let prevSide = side;
            makeMove(move);
            let score = -negamax(depth - 1, -beta, -alpha);
            if (move[4]) score += 2 * depth;
            takeBack(move);
            if (score > bestScore) {
              bestScore = score;
              if (depth === originalDepth) bestMove = move;
            } alpha = Math.max(alpha, bestScore);
            if (alpha >= beta) break;
          } return bestScore;
        }
        const bestScore = negamax(depth, alpha, beta);
        side = oldSide;
        if (!bestMove) bestMove = generateMoves()[0];
        return { bestScore, bestMove };
      }
      
      function computerMove() {
        if (!ai) return;
        setTimeout(function() {
          let oldSide = side;
          let response = search(5);
          if (response.bestMove) {
            gameMoves.push([response.bestMove, side]);
            makeMove(response.bestMove);
            if (moreCapture(response.bestMove)) side = 3 - side;
          } else return;
          drawBoard();
          if (side == oldSide) computerMove();
        }, 800);
      }
      
      function isGameOver() {
        if (gameOver) return;
        let limes = 0;
        let eggs = 0;
        for (let sq = 0; sq < board.length; sq++) {
          if (board[sq] == 3) continue;
          if (board[sq] == 1) eggs += 1;
          if (board[sq] == 2) limes += 1;
        }
        if (!limes) { gameOver = 1; alert('Eggs won!'); }
        if (!eggs) { gameOver = 1; alert('Limes won!'); }
      }
    
      function userMove(sq) {
        var clickSq = parseInt(sq, 10);
        if (!clickLock && board[clickSq]) {
          for (let sq = 0; sq < board.length; sq++)
            if (board[sq] != 3) document.getElementById(clickSq).classList.remove('highlight');
          document.getElementById(clickSq).classList.add('highlight');
          legalMoves = generateMoves();
          for (let move of legalMoves)
            if (clickSq == move[0]) {
              document.getElementById(move[1]).classList.add('highlight');
              userSrc = clickSq;
            }
          clickLock = 1;
        } else if (clickLock) {
          userDst = clickSq;
          drawBoard();
          for (let move of legalMoves)
            if (userSrc == move[0] && userDst == move[1]) {
              gameMoves.push([move, side]);
              makeMove(move);
              drawBoard();
              if (moreCapture(move)) side = 3 - side;
              else computerMove();
            }
          clickLock = 0;
        }
      }
      
      document.getElementById('undo').addEventListener('click', () => {
        if (!gameMoves.length) return;
        let lastMove = gameMoves[gameMoves.length-1];
        takeBack(lastMove[0]);
        side = lastMove[1];
        gameMoves.pop();
        drawBoard();
      });
      
      document.getElementById('move').addEventListener('click', () => {
        computerMove();
      });
      
      document.getElementById('flip').addEventListener('click', () => {
        flip ^= 1;
        drawBoard();
      });
    </script>
  </body>
</html>
